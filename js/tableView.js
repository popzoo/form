;const curDay=new Date();const serverUrl="http://106.12.179.241";const lastDay=new Date(new Date(curDay.getTime()).setHours(0,0,0,0)-1800*1000);var cos;var versionNumList=[];var radioObj=sessionStorage.getItem("statVersion")!=null?sessionStorage.getItem("statVersion"):"public_version";window.onload=authCheck();function authCheck(){if(getCookie("auth")!=null){fetch(serverUrl+'/getauth?auth='+getCookie("auth"),{method:'GET',mode:'cors',cache:'no-store',credentials:'omit',}).then(res=>{return res.json()}).then(json=>{if(json.msg=="success"){getWebsiteConfig()}else{delCookie("auth");alert("密码错误，请刷新页面后重新输入")}}).catch(err=>{console.error('请求错误',err)})}else{let pwd=window.prompt("郑重警告：此页面保密级别为【*绝密*】，仅供特勤人员专用，闲杂人等禁止入内，否则上门查水表!","");if(pwd!=null&&pwd!=""){fetch(serverUrl+'/getauth?auth='+pwd.trim(),{method:'GET',mode:'cors',cache:'no-store',credentials:'omit',}).then(res=>{return res.json()}).then(json=>{if(json.msg=="success"){setCookie('auth',json.auth);getWebsiteConfig()}else{delCookie("auth");alert("密码错误，请刷新页面后重新输入")}}).catch(err=>{console.error('请求错误',err)})}}}function setCookie(a,b){var c=new Date();c.setTime(c.getTime()+365*24*60*60*1000);document.cookie=a+"="+escape(b)+"; domain=popzoo.xyz; path=/; expires="+c.toGMTString()}function getCookie(a){var b,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}function delCookie(a){var b=new Date();b.setTime(b.getTime()-1);var c=getCookie(a);if(c!=null)document.cookie=a+"="+c+"; domain=popzoo.xyz; path=/; expires="+b.toGMTString()}function dateFormat(a,b){let ret;let opt={"Y+":b.getFullYear().toString(),"m+":(b.getMonth()+1).toString(),"d+":b.getDate().toString(),"H+":b.getHours().toString(),"M+":b.getMinutes().toString(),"S+":b.getSeconds().toString()};for(let k in opt){ret=new RegExp("("+k+")").exec(a);if(ret){a=a.replace(ret[1],(ret[1].length==1)?(opt[k]):(opt[k].padStart(ret[1].length,"0")))}};return a}function getWebsiteConfig(){document.getElementById("show_table").style.visibility="visible";let radioNode=document.getElementById(radioObj);radioNode.setAttribute("checked","checked");radioEventListener();fetch("https://cdn.jsdelivr.net/gh/popzoo/pop/json/paramConfig.json",{method:'GET',mode:'cors',cache:'default',credentials:'omit',}).then(res=>{return res.json()}).then(result=>{versionNumList=result.versionNumList;cos=new COS({SecretId:result.cosSecId,SecretKey:result.cosSecKy});getUserNumber(true)}).catch(err=>{console.error('请求错误',err)})}function radioEventListener(){let radioAnchor=document.getElementById("private_version");if(radioAnchor!=undefined){var a=radioAnchor;a.addEventListener("change",(function(){radioFunc('private_version')}));var b=document.getElementById("public_version");b.addEventListener("change",(function(){radioFunc('public_version')}))}else{console.error("无法获取radio元素")}}function radioFunc(a){sessionStorage.setItem("statVersion",a);location.reload()}function getUserNumber(e){var d=[];f(e,"");function f(c,g){cos.getBucket({Bucket:'jumpstat-1253626683',Region:'ap-beijing',Marker:g,Prefix:'JumpCount/'+dateFormat("YYYY-mm-dd",c?curDay:lastDay)+'/',},function(a,b){if(a){console.error(a)}else{h(b)}})}function h(a){let userPartList=a.Contents;for(let m=0;m<userPartList.length;m++){let tempList=userPartList[m].Key.split("@");var b={userAvatar:0,uid:0,uname:'匿名',jumpCount:0,fishBallIncome:0,cashIncome:0,danmuCount:0,version:0,accountBall:0,accountWing:0,userLevel:0,userExp:0,userFollow:0,activeTime:0,danmuError:0};for(let n=0;n<tempList.length;n++){if(tempList[n].indexOf("uid")>-1){b.uid=tempList[n].split("#")[1]}else if(tempList[n].indexOf("uname")>-1){b.uname=tempList[n].split("#")[1]}else if(tempList[n].indexOf("jumpCount")>-1){b.jumpCount=parseInt(tempList[n].split("#")[1])}else if(tempList[n].indexOf("fishBallIncome")>-1){b.fishBallIncome=parseInt(tempList[n].split("#")[1])}else if(tempList[n].indexOf("cashIncome")>-1){b.cashIncome=parseInt(tempList[n].split("#")[1])}else if(tempList[n].indexOf("danmuCount")>-1){b.danmuCount=parseInt(tempList[n].split("#")[1])}else if(tempList[n].indexOf("version")>-1){b.version=(tempList[n].split("#")[1]).replace(/_/g,":")}else if(tempList[n].indexOf("accountBall")>-1){b.accountBall=parseInt(tempList[n].split("#")[1])}else if(tempList[n].indexOf("userLevel")>-1){b.userLevel=parseInt(tempList[n].split("#")[1])}else if(tempList[n].indexOf("userExp")>-1){b.userExp=parseInt(tempList[n].split("#")[1])}else if(tempList[n].indexOf("userFollow")>-1){b.userFollow=parseInt(tempList[n].split("#")[1])}else if(tempList[n].indexOf("userAvatar")>-1){b.userAvatar="https://apic.douyucdn.cn/upload/"+(tempList[n].split("#")[1]).replace(/~/g,'/')}else if(tempList[n].indexOf("accountWing")>-1){b.accountWing=parseFloat(tempList[n].split("#")[1])}else if(tempList[n].indexOf("activeTime")>-1){b.activeTime=parseInt(tempList[n].split("#")[1])}else if(tempList[n].indexOf("danmuError")>-1){b.danmuError=parseInt(tempList[n].split("#")[1])}}d.push(b)}if(a.IsTruncated=="true"){f(e,a.NextMarker)}else{console.info("用户未去重数目："+d.length);d=[].concat(distinctUserList(d));if(d.length>0){console.info(d);requestUserAvatar(d)}}}}function distinctUserList(c){c.sort(function(a,b){return a.activeTime-b.activeTime});result=[];for(let i=0;i<c.length;i++){for(let j=i+1;j<c.length;j++){if(c[i].uid===c[j].uid){j=++i}}result.push(c[i])}return result.reverse()}function requestUserAvatar(a){let num=0;b();function b(){if(num==a.length){renderDataToTable(a)}else{if(a[num].userAvatar==undefined||a[num].userAvatar==0||a[num].userAvatar=="https://apic.douyucdn.cn/upload/0"){fetch('https://bojianger.com/data/api/common/search.do?keyword='+a[num].uid,{method:'GET',mode:'cors',cache:'default',credentials:'omit'}).then(result=>{return result.text()}).then(txt=>{let json=JSON.parse(txt);a[num].userAvatar=json.data.audienceVo.audience_avator;a[num].userLevel=json.data.audienceVo.level;b(++num)}).catch(err=>{console.warn('播酱数据获取失败');b(++num)})}else{b(++num)}}}}function renderDataToTable(c){var g=0;var e=0;var d=0;var f=0;var h=0;var o=0;var p=0;var q=0;var r=new Set();var s=0;var t=0;var u=0;var l=0;c.sort(function(a,b){return b.fishBallIncome-a.fishBallIncome});let tableCell=document.getElementById('render_table_cell');tableCell.firstElementChild.remove();for(let i=0;i<c.length;i++){if(radioObj=="private_version"&&versionNumList.indexOf(c[i].version)>-1){v(c[i],i)}else if(radioObj=="public_version"){v(c[i],i)}}function v(a,b){let outTr=document.createElement('tr');if(b%2==0){outTr.setAttribute("style","background-color:#DDD")}else{outTr.setAttribute("style","background-color:#F7F7F7")}let timeGap=a.activeTime!=0?parseInt((new Date().getTime()-a.activeTime)/1000):0;let timeRest=timeGap;if(timeGap>=3600){timeGap=(timeGap/3600).toFixed(1)+"h"}else{timeGap+="s"}outTr.innerHTML="<td><img src='"+a.userAvatar+"' width='50'></td>";outTr.innerHTML+="<td>"+a.uname+"</td>";outTr.innerHTML+="<td>Lv."+a.userLevel+"</td>";outTr.innerHTML+="<td>"+a.userExp+"点</td>";if(a.userFollow>5700){outTr.innerHTML+="<td style='color:green;'>"+a.userFollow+"个</td>"}else{outTr.innerHTML+="<td>"+a.userFollow+"个</td>"}outTr.innerHTML+="<td>V"+a.version+"</td>";if(a.danmuError>=3){outTr.innerHTML+="<td style='color:red;'>"+a.danmuError+"条</td>"}else{outTr.innerHTML+="<td>"+a.danmuError+"条</td>"}if(timeRest>=150){outTr.innerHTML+="<td style='color:green;'>"+timeGap+"</td>"}else{outTr.innerHTML+="<td>"+timeGap+"</td>"}outTr.innerHTML+="<td>"+a.jumpCount+"次</td>";outTr.innerHTML+="<td>"+a.danmuCount+"条</td>";outTr.innerHTML+="<td>"+a.fishBallIncome+"丸</td>";outTr.innerHTML+="<td>"+a.cashIncome+"元</td>";outTr.innerHTML+="<td>"+a.accountBall+"丸</td>";outTr.innerHTML+="<td>"+a.accountWing.toFixed(1)+"翅</td>";tableCell.appendChild(outTr);e+=1;r.add(a.version);q+=a.userLevel;s+=a.userExp;t+=a.userFollow;g+=a.jumpCount;f+=a.danmuCount;h+=a.fishBallIncome;o+=a.cashIncome;p+=a.accountBall;u+=a.accountWing;timeGap>=150?++d:0;a.danmuError>=3?++l:0}let totalTr=document.createElement('tr');totalTr.setAttribute("style","background-color: #B9D3EE");totalTr.innerHTML+="<td>聚合统计</td>";totalTr.innerHTML+="<td>"+e+"(总)</td>";totalTr.innerHTML+="<td>"+parseInt(q/e)+"(均)</td>";totalTr.innerHTML+="<td>"+parseInt(s/e)+"(均)</td>";totalTr.innerHTML+="<td>"+parseInt(t/e)+"(均)</td>";totalTr.innerHTML+="<td>"+Array.from(r).length+"(总)</td>";if(l>0){totalTr.innerHTML+="<td style='color:red;'>"+l+"(错)</td>"}else{totalTr.innerHTML+="<td>"+l+"(错)</td>"}totalTr.innerHTML+="<td>"+d+"(人)</td>";totalTr.innerHTML+="<td>"+g+"(总)</td>";totalTr.innerHTML+="<td>"+f+"(总)</td>";totalTr.innerHTML+="<td>"+h+"(总)</td>";totalTr.innerHTML+="<td>"+o+"(总)</td>";totalTr.innerHTML+="<td>"+p+"(总)</td>";totalTr.innerHTML+="<td>"+u.toFixed(1)+"(总)</td>";tableCell.appendChild(totalTr)};